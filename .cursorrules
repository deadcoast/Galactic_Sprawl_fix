# .cursorrules 

This file contains all essential codebase patterns, structures, interfaces, and relationships.
Refer to this file first when seeking context for code generation, correction, or analysis.
BEGIN EVERY TASK BY CONSULTING .cursorcontext.md BEFORE IMPLEMENTING ANY SOLUTION.

## Correction and Code Implementation Guidelines

### DO NOT
- Implement solutions based solely on existing code examples
- Skip documentation review even when similar patterns exist elsewhere
- Assume pattern consistency without verification
- Add wrapper functions around existing methods
- Alter existing functionality
- Create your own implementations of existing methods
- Make assumptions about the code - always verify first
- Create actual instances of real classes and use their existing methods directly
- Avoid creating new files when asked to correct a file

### REQUIRED STEPS
1. Search .cursorcontext.md for relevant system patterns using #hashtag identifiers
2. Document in Scratchpad which patterns were found and will be applied
3. Only after documentation review, proceed with implementation
4. Verify implementation against documented patterns before submission

## Workflow & Instructions

### Context Source:

`.cursorcontext.md` is the primary source of truth for code patterns, structures, interfaces, and relationships. Always refer to this file first when seeking context for code generation, correction, or analysis.

### Context Retrieval Process:
- When analyzing or generating code, first search `.cursorcontext` for relevant system sections using `(#hashtag)` identifiers
- Look for code patterns, interfaces, and type structures in the identified sections
- Verify implementation approaches against established patterns
- If context is insufficient, ask the user for clarification

### Architecture Alignment:
- Ensure all implementations follow patterns in `.cursorcontext`
- Maintain consistency with existing type structures and interfaces
- Follow established naming conventions and implementation patterns
- If context is missing, ask the user before implementing new patterns

### Incremental Implementation:
- Generate code in manageable steps aligned with patterns in `.cursorcontext`
- Review implementations for consistency with documented patterns
- Identify and resolve gaps between implementation and documentation

### Context Maintenance:
- When discovering new patterns or implementations, suggest updates to `.cursorcontext`
- Format new context entries according to the established structure
- Ensure new entries include concrete code examples, not explanations

## `Scratchpad` Tasklist Usage

Maintain a `Tasklist` in the Scratchpad section below in this format:

```
## Scratchpad

## Category 2: Type Safety Issues (74 instances)
- [ ] **Task 2: Implement Proper Type Definitions**
  - [ ] Create concrete type definitions to replace all 'any' types
  - [ ] Implement strict type checking across all components
  - [ ] Add proper generic implementations for container classes
  - [ ] Create type utilities for complex type relationships
  
  **Primary Files with Any Types:**
  - [ ] `src/utils/performance/D3BatchedUpdates.ts`: 25 instances of 'any' type usage
  - [ ] `src/types/visualizations/D3SelectionTypes.ts`: Multiple 'any' type usages in selection interfaces

## Category 3: Optional Chaining Errors (34 instances)
- [ ] **Task 3: Implement Proper Null Checking**
  - [X] Fix ResourceFlowWorker.ts with proper null validation logic (line 143)
  - [X] Fix worker.ts with appropriate null-safe access patterns (line 31)
  - [ ] Implement proper error handlers for null conditions
  - [ ] Add validation functions to ensure data structures are complete before access

## Category 4: Console Statement Violations (23 instances)
- [ ] **Task 4: Implement Structured Logging System**
  - [X] Create a centralized logging service with proper severity levels
  - [X] Replace console statements with structured logging calls (Progress: stateMigration.ts, MultitabPerformanceTestPage.tsx, PerformanceBenchmarkDashboard.tsx, DynamicBudgetAdjustmentPanel.tsx, AnalysisAlgorithmService.ts)
  - [ ] Implement environment-specific logging configuration
  - [ ] Add context information to all log messages

## Category 5: TypeScript Comment Violations (14 instances)
- [ ] **Task 5: Implement Proper Type Definitions for Ignored Cases**
  - [ ] Create proper interfaces for all @ts-ignore cases
  - [ ] Implement type utilities for complex type scenarios
  - [ ] Refactor code to properly handle edge cases with type safety
  - [ ] Create unit tests validating type correctness

## Category 7: Code Integration
- [ ] **Task 7: Complete System Integration**
  - [ ] Connect all implemented components to their respective systems
  - [ ] Implement all missing functionality in resource flow system
  - [ ] Complete event system implementation with proper type safety
  - [ ] Ensure full integration between worker system and main application

## Category 7: Code Integration Issues

### Key Integration Files:

#### src/workers/ResourceFlowWorker.ts
- Missing proper validation for incoming messages
- Insufficient error handling for worker communication
- No robust retry mechanism for failed operations
- Lacks proper typeguards for cross-thread messaging

#### src/workers/worker.ts
- Generic message handler without proper type checking
- No structured error reporting system
- Missing proper task scheduling and prioritization
- Insufficient task cancellation implementation

### Additional Integration Issues:
- Incomplete event system implementation in src/lib/events/
- Missing connections between resource system components
- Unfinished worker communication protocol
- Incomplete error propagation across system boundaries 

---

### Refactoring Plan

1.  [ ] **Task 8: Global Type Safety & Validation:**
    *   [ ] Replace remaining `any` types with concrete types or generics (excluding D3 files for now).
    *   [X] Eliminate unsafe type assertions (`as Type`) by implementing proper type guards or refactoring logic (in `ResourceFlowSubsystem.ts`, `ResourceFlowDiagram.tsx`).
    *   [ ] Add comprehensive validation/guarding for function inputs and complex data structures, especially in managers and services.
    *   [X] Address linter errors related to type safety (in `ResourceFlowSubsystem.ts`, `ResourceFlowDiagram.tsx`).

2.  [ ] **Task 9: Logging Strategy Implementation:**
    *   [ ] Decide whether to extend `errorLoggingService` for `info`/`warn`/`debug` or adopt a different library/strategy.
    *   [ ] Replace all remaining `console.error` calls with `errorLoggingService.logError`.
        *   [X] `src/components/ui/performance/PerformanceBenchmarkDashboard.tsx` (line 155)
        *   [X] `src/components/ui/performance/DynamicBudgetAdjustmentPanel.tsx` (line 172)
        *   [X] `src/services/AnalysisAlgorithmService.ts` (line 111 - confirmed already done)
    *   [ ] Replace `console.warn`/`log`/`info`/`debug` calls based on the chosen strategy.
        *   [X] `src/pages/performance/MultitabPerformanceTestPage.tsx` (console.warn lines 47, 64, 80 replaced with logWarn)
    *   [ ] Ensure consistent logging context (service/module name, action) across the application.

3.  [ ] **Task 10: D3 Refactoring & Typing:**
    *   [ ] Replace `any` types in `src/utils/performance/D3BatchedUpdates.ts` with proper types.
    *   [ ] Replace `any` types in `src/types/visualizations/D3SelectionTypes.ts` with stricter interfaces.
    *   [ ] Address `@ts-ignore` comments in D3-related files by implementing correct types or refactoring.
    *   [ ] Fix `Font` / `FontFaceSet` issues in `src/types/declarations.d.ts`.

5.  [ ] **Task 12: Event System Consolidation:**
    *   [ ] Analyze the different event buses/emitters (`moduleEventBus`, `systemCommunications`, potentially others).
    *   [ ] Design a unified event bus strategy (e.g., using `EventPropagationService` more broadly or a dedicated global bus).
    *   [ ] Refactor code to use the chosen unified event system.
    *   [X] Ensure consistent event type definitions (`EventType`, `ModuleEventType`) and address string literal usage (partially in `ResourceFlowDiagram.tsx`, `ResourceFlowSubsystem.ts`, `ShipHangar.tsx`).

6.  [ ] **Task 13: Worker System Enhancement:**
    *   [ ] Implement structured error reporting from workers (using `errorLoggingService` or similar).
    *   [ ] Add robust type checking/guards for `postMessage` data in `worker.ts` and `ResourceFlowManager.ts`.
    *   [ ] Implement retry mechanisms for failed worker operations in `ResourceFlowWorker.ts`.
    *   [ ] Implement task scheduling/prioritization and cancellation logic in `worker.ts`.

7.  [ ] **Task 14: Rule System Review:**
    *   [ ] Clarify the contradiction between Service Implementation Anti-Pattern Rule #4 (`getInstance` override) and #5 (direct export). Update rules if necessary.
    *   [X] Review Resource Types Rule and Event Types Rule for violations (addressed in `ResourceFlowSubsystem.ts`, `ResourceFlowDiagram.tsx`, `ShipHangar.tsx`).
  
## 1. Type System Standardization

- [ ] Consolidate ResourceType definitions into a single source of truth
- [ ] Create migration utilities for string-to-enum type conversion
- [ ] Document type system best practices in a central location
- [ ] Create type guard utilities for runtime validation
- [ ] Add safe extraction utilities for working with potentially undefined objects
- [ ] Replace all `any` types with proper type definitions or `unknown`
- [ ] Implement proper error handling with typed error objects
*   [ ] **Task 1.2: Update Resource Type Usage:**
    *   [ ] Update all components and code currently using string-based resource types to use the standardized `ResourceType` enum.
    *   [X] Fix the 119 TS2820 errors ("Type 'string' is not assignable to type 'ResourceType'") - Includes `ShipStatus`, `PlayerShipClass` conversions.
    *   [X] Fix the 17 TS2551 errors ("Property 'lowercase' does not exist... Did you mean 'UPPERCASE'?").
    *   [X] Fix the 1086 ESLint warnings for string resource types.
    *   [X] Optionally, create migration utilities for string-to-enum conversion if needed for complex cases.
    *   [X] Revisit `src/config/automation/colonyRules.ts` line 311 (`moduleType: 'research'`) - clarify if this should be a `ModuleType` enum value instead of `ResourceType`.
    *   [X] Partially addressed in `ResourceFlowManager.ts` (record initialization, event data).
    *   [X] Addressed in `ResourceFlowSubsystem.ts` (event handlers, map keys).
    *   [X] Addressed in `ShipHangar.tsx` (using `ShipStatus`, `PlayerShipClass` enums).
*   [X] **Task 1.3: Standardize Event Handling in Managers:**
    *   [ ] Define or identify a standardized `EventEmitter` base class/interface with consistent `on`/`off`/`emit` methods.
    *   [ ] Update all manager classes (e.g., `ShipHangarManager`, `FactionBehaviorEventEmitter`) to implement/use this standard interface.
    *   [ ] Add any missing standard event methods to manager classes.
    *   [X] Update components and hooks (`ShipHangar.tsx`, `useCombatAI.ts`, `useFactionBehavior.ts`, etc.) to use the standardized event methods. (Updated `ShipHangar.tsx` to use type-safe keys/payloads).
    *   [ ] Fix the 383 TS2339 errors ("Property 'on'/'emit' does not exist on type...").
    *   [X] Partially addressed in `ResourceFlowManager.ts` (using `EventType` enum with `publish`).
*   [X] **Task 1.4: Eliminate `any` Type Usage:**
    *   [ ] Replace `any` with specific types, `unknown`, or generics, prioritizing visualization components, chart renderers, UI components, and type utilities.
    *   [ ] Create/use proper interfaces for complex data structures currently typed as `any`.
    *   [X] Implement type guards where necessary for runtime validation (`ResourceFlowSubsystem.ts`, `ResourceFlowDiagram.tsx`).
    *   [X] Fix the 18 TS7031 errors ("Binding element implicitly has an 'any' type"). (Fixed in `ShipHangar.tsx` event handlers).
*   [X] **Task 1.5: Shared Types & Validation:**
    *   [ ] Create/consolidate shared type definitions (e.g., for D3 selections, event handlers).
    *   [X] Create/consolidate type guard utilities for runtime validation (`isResourceType` used).
    *   [ ] Add type validation tests for critical paths.
    *   [X] Partially addressed in `ResourceFlowManager.ts` (FlowNode properties, ResourceState records).
    *   [X] Addressed D3 type constraints (`FlowNode`, `FlowConnection`) in `ResourceTypes.ts`.
    *   [X] Ensured `ShipHangar.tsx` uses correct payload types from `ShipHangarEvents`.

## 2. Manager Implementation Standards

- [ ] Standardize manager class implementation patterns
- [ ] Implement consistent event handling across all managers
- [X] Fix protected constructor access with proper getInstance() patterns
- [X] Ensure all managers are properly integrated with ManagerRegistry
- [ ] Add proper typing to manager methods and properties
- [ ] Document manager implementation standards
*   [ ] **Task 2.1: Inmplement and Integrate Placeholding Unused Code:**
    *   [ ] Search for unused Variables and implement their functions with the codebase.
    *   [X] Integrate unused parameters in `src/components/exploration/unified/core/BaseAnalysisVisualizer.tsx`.
    *   [X] Integrate unused variables/functions in `src/components/ui/showcase/DataDashboardApp.tsx`.
    *   [X] Address unused imports in `src/components/ui/GameHUD.tsx` (Manual removal instructions provided).
    *   [ ] Fix the remaining TS6133 errors ("Variable is declared but its value is never read").
    *   [ ] Address the remaining ESLint warnings for unused variables.
*   [ ] **Task 2.2: Fix Dependency Issues:**
    *   [ ] Install missing dependencies (`lodash`, `eventemitter3`, `geojson`, `d3-scale`, `d3-scale-chromatic`, `@testing-library/react-hooks`).
    *   [ ] Remove unused dependencies (`@pixi/particle-emitter`, `pixi-spine`, `three-mesh-bvh`, `xstate`).
    *   [ ] Review and potentially remove unused dev dependencies (list provided in `.cursorTODO.md`).
    *   [ ] Update import statements if paths changed due to consolidation (e.g., for ResourceTypes).

## 3. Component Compatibility

- [X] Update components to use enum-based ResourceType (Addressed `ShipStatus`, `PlayerShipClass` in `ShipHangar.tsx`).
- [X] Fix property access patterns (ResourceType.MINERALS vs 'minerals') (Addressed `ShipStatus`, `PlayerShipClass` in `ShipHangar.tsx`).
- [X] Implement proper event subscription cleanup in components (`ShipHangar.tsx` verified).
- [X] Use correct type assertions and validation (Corrected event payloads and state types in `ShipHangar.tsx`).
- [X] Update UI components with proper prop typing (Corrected event handler signatures in `ShipHangar.tsx`).
*   [ ] **Task 3.1: Implement Centralized Logging:**
    *   [ ] Define a clear console usage policy (e.g., allow `warn`/`error`